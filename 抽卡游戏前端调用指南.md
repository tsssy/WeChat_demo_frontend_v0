# 抽卡游戏前端调用指南

## 概述

这是一个基于性格测试的抽卡游戏系统，用户通过回答16道性格测试题目，系统会根据答案计算出最匹配的人格卡片。游戏包含8张不同的人格卡片，每张卡片代表一种独特的性格类型。

## API 基础信息

- **基础URL**: `https://loveluretech.xyz/api/v1/CardGame`
- **请求格式**: JSON
- **响应格式**: JSON
- **认证方式**: 无需认证（目前版本）

---

## 📋 API 接口列表

### 1. 开始性格测试 `/start`
### 2. 提交答案 `/answer`
### 3. 获取测试结果 `/result/{session_id}`
### 4. 获取测试历史 `/history/{user_id}`
### 5. 获取系统统计 `/stats`
### 6. 清理过期会话 `/cleanup`

---

## 🗄️ 数据库格式说明

### 性格测试题目表 `personality_questions`
```json
{
  "_id": "ObjectId",
  "question_id": "Q1",
  "question_text": "如果周末一个人待着，你最想做的是？",
  "options": [
    {
      "option": "A",
      "text": "开启一场即兴小旅行",
      "personality_type": "A1"
    },
    {
      "option": "B", 
      "text": "实践一个一直想做的点子项目",
      "personality_type": "A2"
    },
    {
      "option": "C",
      "text": "去熟悉的地方静静坐一下午", 
      "personality_type": "A3"
    },
    {
      "option": "D",
      "text": "躺在床上听歌，想象不可能的恋爱剧情",
      "personality_type": "A4"
    }
  ],
  "created_at": "2025-01-01T12:00:00Z"
}
```

### 人格卡片表 `personality_cards`
```json
{
  "_id": "ObjectId",
  "card_id": "A1",
  "card_name": "风之旅人",
  "title": "你是风的旅人，自由、不羁，像山谷中穿梭的灵魂。",
  "content": "你热爱思考，也擅长沟通。你讨厌束缚与黏腻，追求独立灵魂的双向靠近。你要找的人，是那个愿意与你同行，而不是牵绊你步伐的人。",
  "emoji": "🌀",
  "image_name": "a1.jpg",
  "visual_style": {
    "keywords": ["青年", "山谷中迎风站立", "风蚀衣角", "手持折扇或纸鹤"],
    "style": "极简线条 + 淡蓝调 + 透明感插画"
  },
  "created_at": "2025-01-01T12:00:00Z"
}
```

### 测试记录表 `personality_test_records`
```json
{
  "_id": "ObjectId",
  "session_id": "session_20250101_12345",
  "user_id": 12345,
  "answers": [
    {
      "question_id": "Q1",
      "selected_option": "A",
      "personality_type": "A1"
    }
  ],
  "scores": {
    "A1": 5,
    "A2": 3,
    "A3": 2,
    "A4": 1,
    "A5": 2,
    "A6": 1,
    "A7": 1,
    "A8": 1
  },
  "result_card": "A1",
  "completed": true,
  "started_at": "2025-01-01T12:00:00Z",
  "completed_at": "2025-01-01T12:05:00Z"
}
```

---

## 🔌 详细 API 接口说明

### 1. 开始性格测试

**接口**: `POST /api/v1/CardGame/start`

**描述**: 创建新的性格测试会话并返回第一道题目

**请求体**:
```json
{
  "user_id": 12345
}
```

**成功响应** (200):
```json
{
  "status": "success",
  "data": {
    "session_id": "session_20250101_12345",
    "current_question": {
      "question_id": "Q1",
      "question_text": "如果周末一个人待着，你最想做的是？",
      "options": [
        {
          "option": "A",
          "text": "开启一场即兴小旅行",
          "personality_type": "A1"
        },
        {
          "option": "B",
          "text": "实践一个一直想做的点子项目", 
          "personality_type": "A2"
        },
        {
          "option": "C",
          "text": "去熟悉的地方静静坐一下午",
          "personality_type": "A3"
        },
        {
          "option": "D",
          "text": "躺在床上听歌，想象不可能的恋爱剧情",
          "personality_type": "A4"
        }
      ]
    },
    "progress": {
      "current": 1,
      "total": 16
    }
  },
  "error": null
}
```

**错误响应** (400/500):
```json
{
  "status": "error",
  "data": null,
  "error": "创建测试会话失败，请稍后重试"
}
```

---

### 2. 提交答案

**接口**: `POST /api/v1/CardGame/answer`

**描述**: 提交题目答案并获取下一题或测试结果

**请求体**:
```json
{
  "session_id": "session_20250101_12345",
  "question_id": "Q1",
  "selected_option": "A"
}
```

**成功响应 - 继续下一题** (200):
```json
{
  "status": "success",
  "data": {
    "is_completed": false,
    "next_question": {
      "question_id": "Q2",
      "question_text": "面对新关系，你最自然的状态是？",
      "options": [
        {
          "option": "A",
          "text": "自然而然地交流，不主动也不抗拒",
          "personality_type": "A3"
        },
        {
          "option": "B",
          "text": "一旦确定好感就会主动出击",
          "personality_type": "A2"
        },
        {
          "option": "C",
          "text": "暗暗观察，等自己确认安全再靠近",
          "personality_type": "A6"
        },
        {
          "option": "D",
          "text": "如果对方像阳光一样有吸引力，我会靠近",
          "personality_type": "A8"
        }
      ]
    },
    "progress": {
      "current": 2,
      "total": 16
    }
  },
  "error": null
}
```

**成功响应 - 测试完成** (200):
```json
{
  "status": "success",
  "data": {
    "is_completed": true,
    "result": {
      "card": {
        "card_id": "A1",
        "card_name": "风之旅人",
        "title": "你是风的旅人，自由、不羁，像山谷中穿梭的灵魂。",
        "content": "你热爱思考，也擅长沟通。你讨厌束缚与黏腻，追求独立灵魂的双向靠近。你要找的人，是那个愿意与你同行，而不是牵绊你步伐的人。",
        "emoji": "🌀",
        "image_name": "a1.jpg",
        "visual_style": {
          "keywords": ["青年", "山谷中迎风站立", "风蚀衣角", "手持折扇或纸鹤"],
          "style": "极简线条 + 淡蓝调 + 透明感插画"
        }
      },
      "scores": {
        "A1": 5,
        "A2": 3,
        "A3": 2,
        "A4": 1,
        "A5": 2,
        "A6": 1,
        "A7": 1,
        "A8": 1
      }
    }
  },
  "error": null
}
```

**错误响应** (400/404/500):
```json
{
  "status": "error",
  "data": null,
  "error": "会话不存在或已过期"
}
```

---

### 3. 获取测试结果

**接口**: `GET /api/v1/CardGame/result/{session_id}`

**描述**: 根据会话ID获取性格测试结果

**路径参数**:
- `session_id`: 测试会话ID

**成功响应** (200):
```json
{
  "status": "success",
  "data": {
    "session_id": "session_20250101_12345",
    "result": {
      "card": {
        "card_id": "A1",
        "card_name": "风之旅人",
        "title": "你是风的旅人，自由、不羁，像山谷中穿梭的灵魂。",
        "content": "你热爱思考，也擅长沟通。你讨厌束缚与黏腻，追求独立灵魂的双向靠近。你要找的人，是那个愿意与你同行，而不是牵绊你步伐的人。",
        "emoji": "🌀",
        "image_name": "a1.jpg",
        "visual_style": {
          "keywords": ["青年", "山谷中迎风站立", "风蚀衣角", "手持折扇或纸鹤"],
          "style": "极简线条 + 淡蓝调 + 透明感插画"
        }
      },
      "scores": {
        "A1": 5,
        "A2": 3,
        "A3": 2,
        "A4": 1,
        "A5": 2,
        "A6": 1,
        "A7": 1,
        "A8": 1
      }
    },
    "completed_at": "2025-01-01T12:05:00Z"
  },
  "error": null
}
```

**错误响应** (404):
```json
{
  "status": "error",
  "data": null,
  "error": "测试结果不存在"
}
```

---

### 4. 获取测试历史

**接口**: `GET /api/v1/CardGame/history/{user_id}`

**描述**: 获取用户的性格测试历史记录

**路径参数**:
- `user_id`: 用户ID

**查询参数**:
- `page`: 页码（可选，默认1）
- `limit`: 每页数量（可选，默认10）

**成功响应** (200):
```json
{
  "status": "success",
  "data": {
    "user_id": 12345,
    "history": [
      {
        "session_id": "session_20250101_12345",
        "result_card": {
          "card_id": "A1",
          "card_name": "风之旅人",
          "emoji": "🌀"
        },
        "completed_at": "2025-01-01T12:05:00Z"
      },
      {
        "session_id": "session_20241225_12345",
        "result_card": {
          "card_id": "A3",
          "card_name": "静水之眼",
          "emoji": "💧"
        },
        "completed_at": "2024-12-25T15:30:00Z"
      }
    ],
    "total": 2,
    "page": 1,
    "limit": 10
  },
  "error": null
}
```

**错误响应** (404):
```json
{
  "status": "error",
  "data": null,
  "error": "用户不存在"
}
```

---

### 5. 获取系统统计

**接口**: `GET /api/v1/CardGame/stats`

**描述**: 获取性格测试系统的统计信息 (管理功能)

**成功响应** (200):
```json
{
  "status": "success",
  "data": {
    "total_questions": 16,
    "total_cards": 8,
    "total_sessions": 1250,
    "completed_sessions": 1180,
    "active_sessions": 25,
    "card_distribution": {
      "A1": 147,
      "A2": 135,
      "A3": 152,
      "A4": 128,
      "A5": 149,
      "A6": 131,
      "A7": 143,
      "A8": 145
    }
  },
  "error": null
}
```

---

### 6. 清理过期会话

**接口**: `DELETE /api/v1/CardGame/cleanup`

**描述**: 清理未完成的过期测试会话 (维护功能)

**成功响应** (200):
```json
{
  "status": "success",
  "data": {
    "cleaned_sessions": 15,
    "message": "已清理15个过期会话"
  },
  "error": null
}
```

---

## 🎮 完整调用流程示例

### JavaScript/TypeScript 示例

```javascript
class PersonalityTestAPI {
  constructor(baseURL = 'https://loveluretech.xyz/api/v1/CardGame') {
    this.baseURL = baseURL;
  }

  // 开始测试
  async startTest(userId) {
    try {
      const response = await fetch(`${this.baseURL}/start`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ user_id: userId })
      });
      
      const data = await response.json();
      
      if (data.status === 'success') {
        return {
          sessionId: data.data.session_id,
          question: data.data.current_question,
          progress: data.data.progress
        };
      } else {
        throw new Error(data.error);
      }
    } catch (error) {
      console.error('开始测试失败:', error);
      throw error;
    }
  }

  // 提交答案
  async submitAnswer(sessionId, questionId, selectedOption) {
    try {
      const response = await fetch(`${this.baseURL}/answer`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          session_id: sessionId,
          question_id: questionId,
          selected_option: selectedOption
        })
      });
      
      const data = await response.json();
      
      if (data.status === 'success') {
        return {
          isCompleted: data.data.is_completed,
          nextQuestion: data.data.next_question,
          result: data.data.result,
          progress: data.data.progress
        };
      } else {
        throw new Error(data.error);
      }
    } catch (error) {
      console.error('提交答案失败:', error);
      throw error;
    }
  }

  // 获取测试结果
  async getResult(sessionId) {
    try {
      const response = await fetch(`${this.baseURL}/result/${sessionId}`);
      const data = await response.json();
      
      if (data.status === 'success') {
        return data.data;
      } else {
        throw new Error(data.error);
      }
    } catch (error) {
      console.error('获取测试结果失败:', error);
      throw error;
    }
  }

  // 获取测试历史
  async getHistory(userId, page = 1, limit = 10) {
    try {
      const response = await fetch(
        `${this.baseURL}/history/${userId}?page=${page}&limit=${limit}`
      );
      const data = await response.json();
      
      if (data.status === 'success') {
        return data.data;
      } else {
        throw new Error(data.error);
      }
    } catch (error) {
      console.error('获取测试历史失败:', error);
      throw error;
    }
  }
}

// 使用示例
async function playPersonalityTest() {
  const api = new PersonalityTestAPI();
  const userId = 12345;

  try {
    // 1. 开始测试
    console.log('🎮 开始性格测试...');
    const startResult = await api.startTest(userId);
    console.log('测试会话ID:', startResult.sessionId);
    console.log('第一题:', startResult.question);

    let currentQuestion = startResult.question;
    let sessionId = startResult.sessionId;
    let questionCount = 1;

    // 2. 循环答题
    while (true) {
      console.log(`\n📝 第${questionCount}题: ${currentQuestion.question_text}`);
      currentQuestion.options.forEach(option => {
        console.log(`${option.option}. ${option.text}`);
      });

      // 模拟用户选择（实际应该从UI获取）
      const userChoice = 'A'; // 这里应该是用户的实际选择
      console.log(`用户选择: ${userChoice}`);

      // 提交答案
      const answerResult = await api.submitAnswer(
        sessionId, 
        currentQuestion.question_id, 
        userChoice
      );

      if (answerResult.isCompleted) {
        // 测试完成，显示结果
        console.log('\n🎉 测试完成！');
        console.log('你的人格卡片是:', answerResult.result.card.card_name);
        console.log('卡片描述:', answerResult.result.card.title);
        console.log('详细内容:', answerResult.result.card.content);
        console.log('表情符号:', answerResult.result.card.emoji);
        console.log('各类型得分:', answerResult.result.scores);
        break;
      } else {
        // 继续下一题
        currentQuestion = answerResult.nextQuestion;
        questionCount++;
        console.log(`进度: ${answerResult.progress.current}/${answerResult.progress.total}`);
      }
    }

    // 3. 获取历史记录
    console.log('\n📚 获取测试历史...');
    const history = await api.getHistory(userId);
    console.log('历史测试次数:', history.total);
    history.history.forEach((item, index) => {
      console.log(`${index + 1}. ${item.result_card.card_name} ${item.result_card.emoji} (${item.completed_at})`);
    });

  } catch (error) {
    console.error('测试过程中发生错误:', error);
  }
}

// 启动测试
// playPersonalityTest();
```

---

## 🔧 人格类型映射表

| 卡片ID | 卡片名称 | 表情符号 | 主要特征 |
|--------|----------|----------|----------|
| A1 | 风之旅人 | 🌀 | 自由不羁，热爱思考，善于沟通 |
| A2 | 烈焰信徒 | 🔥 | 热情如火，坦率专注，行动力强 |
| A3 | 静水之眼 | 💧 | 表面平静，内心深情，不善表达 |
| A4 | 星尘拾梦人 | ⭐ | 浪漫梦幻，相信奇迹，富有想象力 |
| A5 | 原野守望者 | 🌾 | 踏实稳重，不急不躁，值得依靠 |
| A6 | 沉思诗者 | 📖 | 善于感知，思维深邃，喜欢独处 |
| A7 | 月下旅者 | 🌙 | 安静独行，追求真实，害怕失真 |
| A8 | 晨光梦想家 | ⭐ | 乐观积极，相信成长，充满理想 |

---

## ⚠️ 注意事项

1. **会话管理**: 测试会话有时效性，长时间未活动会自动过期
2. **数据验证**: 提交的选项必须是 A、B、C、D 中的一个
3. **错误处理**: 前端应该妥善处理网络错误和业务逻辑错误
4. **性能优化**: 建议对API响应进行缓存，避免重复请求
5. **用户体验**: 在等待API响应时显示加载状态

---

## 🚀 部署和配置

### 开发环境
- 服务器地址: `https://loveluretech.xyz`
- 数据库: MongoDB
- 文档地址: `https://loveluretech.xyz/docs`

### 生产环境
- 请根据实际部署情况修改 `baseURL`
- 配置适当的CORS策略
- 启用HTTPS加密

---

## 📝 更新日志

- **v1.0.1** (2025-01-01): 路由冲突修复版本
  - **重要变更**: API路由前缀从 `/api/v1/personality` 更改为 `/api/v1/CardGame`
  - 修复与现有AI模块 `/api/v1/ai/history` 的语义冲突
  - 统一路由命名规范，使用更清晰的"CardGame"前缀
  - 所有API接口功能保持不变，仅路径更新

- **v1.0.0** (2025-01-01): 初版发布，包含完整的抽卡游戏功能
  - 16道性格测试题目
  - 8张人格卡片
  - 完整的测试流程
  - 历史记录功能
  - 系统统计功能

---

## 🤝 支持与反馈

如有问题或建议，请联系开发团队或在项目仓库提交Issue。 